#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e
set -o pipefail

# Helper to export environment
export_env_dir() {
  env_dir=$1
  whitelist_regex=${2:-''}
  blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

BUILD_DIR=$1
CACHE_DIR=$2

cd $BUILD_DIR

# From the luarocks website
# Do I need sudo for bootstrap? Do I need bootstrap directory?
echo "-----> Fetching luarocks..."
wget http://luarocks.org/releases/luarocks-2.4.0.tar.gz
tar zxpf luarocks-2.4.0.tar.gz
cd luarocks-2.4.0
./configure; make bootstrap
cd ..

# Get LuaJIT
# Do I need sudo for install? Set up install directory?
echo "-----> Fetching LuaJIT..."
wget http://luajit.org/download/LuaJIT-2.0.4.tar.gz
tar zxf LuaJIT-2.0.4.tar.gz
cd LuaJIT-2.0.4
make && make install
cd ..

# Install moonmint and openssl
luarocks install moonmint
luarocks install openssl
