#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e
set -o pipefail

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# Unload cache
mkdir -p $CACHE_DIR
cp -r ${CACHE_DIR%/} ${BUILD_DIR%/}

cd $BUILD_DIR

# Create bin and add it to the PATH
mkdir -p bin
mkdir -p include
export PATH=$(cd bin; pwd):$PATH

# Get LuaJIT
# Do I need sudo for install? Set up install directory?
echo "-----> Fetching LuaJIT..."
wget http://luajit.org/download/LuaJIT-2.0.4.tar.gz
tar zxf LuaJIT-2.0.4.tar.gz
pushd LuaJIT-2.0.4
make
make install PREFIX="${BUILD_DIR%/}"
popd
rm -rf LuaJIT-2.0.4

# From the luarocks website
echo "-----> Fetching luarocks..."
CACHED=no
wget http://luarocks.org/releases/luarocks-2.4.0.tar.gz
tar zxpf luarocks-2.4.0.tar.gz
pushd luarocks-2.4.0
./configure --lua-suffix="jit" --prefix="${BUILD_DIR%/}" --with-lua-include="${BUILD_DIR%/}/include/luajit-2.0"
make build
make install
popd

# Get Cmake
echo "-----> Fetching CMake..."
CACHED=no
wget https://cmake.org/files/v3.6/cmake-3.6.2.tar.gz
tar zxpf cmake-3.6.2.tar.gz
pushd cmake-3.6.2
./bootstrap --prefix="${BUILD_DIR%/}"
make
make install
popd

# Install moonmint
${BUILD_DIR%/}/bin/luarocks install --server=http://luarocks.org/dev moonmint

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
luarocks path --bin > $DIR/../.profile.d/luarocks.sh
