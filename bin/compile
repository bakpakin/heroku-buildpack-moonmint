#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e
set -o pipefail

# Helper to export environment
export_env_dir() {
  env_dir=$1
  whitelist_regex=${2:-''}
  blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# Unload cache
cp -r ${CACHE_DIR%/} ${BUILD_DIR%/}

cd $BUILD_DIR

# Create bin and add it to the PATH
mkdir -p bin
mkdir -p include
PATH=$(cd bin; pwd):$PATH

# Get LuaJIT
# Do I need sudo for install? Set up install directory?
if [ -f ${BUILD_DIR%/}/bin/luajit ]; then
    echo "-----> LuaJIT cached."
else
    echo "-----> Fetching LuaJIT..."
    wget http://luajit.org/download/LuaJIT-2.0.4.tar.gz
    tar zxf LuaJIT-2.0.4.tar.gz
    pushd LuaJIT-2.0.4
    make
    make install PREFIX="${BUILD_DIR%/}"
    popd
    rm -rf LuaJIT-2.0.4
fi

# From the luarocks website
if [ -f ${BUILD_DIR%/}/bin/luarocks ]; then
    echo "-----> Luarocks cached."
else
    echo "-----> Fetching luarocks..."
    wget http://luarocks.org/releases/luarocks-2.4.0.tar.gz
    tar zxpf luarocks-2.4.0.tar.gz
    pushd luarocks-2.4.0
    ./configure --lua-suffix="jit" --prefix="${BUILD_DIR%/}" --with-lua-include="${BUILD_DIR%/}/include/luajit-2.0"
    make build
    make install
    popd
fi

# Get Cmake
if [ -f ${BUILD_DIR%/}/bin/cmake ]; then
    echo "-----> CMake cached."
else
    echo "-----> Fetching CMake..."
    wget https://cmake.org/files/v3.6/cmake-3.6.2.tar.gz
    tar zxpf cmake-3.6.2.tar.gz
    pushd cmake-3.6.2
    ./bootstrap --prefix="${BUILD_DIR%/}"
    make
    make install
    popd
fi

# Install moonmint
${BUILD_DIR%/}/bin/luarocks install --server=http://luarocks.org/dev moonmint

# Cache everything
cp -r ${BUILD_DIR%/} ${CACHE_DIR%/}

# TODO: run luarocks make if there is a rockspecs file.
